<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web Truyá»‡n VIP </title>
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/29/29302.png">




  
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
*{box-sizing:border-box}

/* Ä‘á»•i mÃ u ná»n */
body{
  margin:0;
  font-family:Arial;
  background:#a28484;
  color:#151212;
}


/* HEADER */
/* Ä‘á»•i mÃ u nÃºt */
header{
  position:sticky;
  top:0;
  z-index:99;
  background:#000000;
  color:#ce280b;
  padding:20px;
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  align-items:center;
  border-bottom:10px solid #858547;

  font-size:21px; /* ğŸ‘ˆ tÄƒng cá»¡ chá»¯ */
}

/* Ä‘á»•i mÃ u nÃºt */
button{
  padding:8px 12px;
  border:1px solid #cd2c2c;
  border-radius:6px;
  background:#100f0f;
  color:#a87777;
  cursor:pointer;
  font-weight:500;
}

button:hover{
  background:#c10000;
}


/* VIP PANEL */
#vipPanel{
  background:#111;color:gold;
  padding:10px;margin:10px;
  border-radius:8px;
  font-weight:bold;text-align:center
}

/* STORIES */
/* ===== DANH SÃCH TRUYá»†N Dáº NG HÃ€NG NGANG ===== */
#stories{
  max-width:900px;
  margin:20px auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:15px;
}

.story{
  display:flex;
  gap:15px;
  align-items:center;
  background:#111;
  padding:12px;
  border-radius:12px;
  transition:0.3s;
}

.story:hover{
  background:#1b0000;
  transform:translateY(-3px);
}


.story img{
  width:160px;              /* cá»‘ Ä‘á»‹nh chiá»u ngang */
  aspect-ratio:16/9;        /* chuáº©n YouTube */
  object-fit:contain;
  background:#000;      /* thÃªm ná»n Ä‘en cho Ä‘áº¹p */
  border-radius:10px;
}
.story img{
  filter:brightness(0.9);
}
.story:hover img{
  filter:brightness(1.1);
}


.story-info{
  flex:1;
}

.story-info h3{
  margin:0;
  color:#ff2a2a;
  font-size:18px;
}

.story-info p{
  margin-top:8px;
  color:#ccc;
  font-size:14px;
}

/* ===== MOBILE ===== */
@media(max-width:600px){

  .story{
    flex-direction:column;   /* chuyá»ƒn thÃ nh dá»c */
    align-items:flex-start;
  }

  .story img{
    width:100%;              /* full chiá»u ngang */
    aspect-ratio:16/9;
  }

  .story-info{
    width:100%;
  }

  .story-info h3{
    font-size:16px;
    margin-top:8px;
  }

  .story-info p{
    font-size:13px;
  }
}




/* DETAIL */
#detail{padding:10px}
.chapter{
  padding:12px;border-bottom:1px solid #ddd;
  cursor:pointer
}
.chapter.vip-lock{color:#999}
.vip{color:gold;font-weight:bold}

/* VIDEO */
video,iframe{
  width:100%;aspect-ratio:16/9;
  margin-top:10px;
  border-radius:10px;
  background:#000
}

/* MODAL */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background: radial-gradient(circle at center, #1a0000, #000000);
  justify-content:center;
  align-items:center;
  z-index:1000;
  overflow:hidden;
}

.box{
  width:420px;
  padding:40px;
  background:rgba(0,0,0,0.9);
  border-radius:20px;
  box-shadow:0 0 40px red;
  text-align:center;
  position:relative;
  z-index:2;
  color:white;
}

.box h3{
  color:#ff0000;
  margin-bottom:20px;
}

.box input{
  width:100%;
  padding:12px;
  margin:10px 0;
  border:none;
  border-radius:8px;
  background:#111;
  color:white;
  border:1px solid #330000;
}

.box input:focus{
  border:1px solid red;
  box-shadow:0 0 10px red;
}

.box button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  background:linear-gradient(45deg,#ff0000,#990000);
  color:white;
  font-weight:bold;
}

.box input{
  width:100%;
  padding:10px;margin-bottom:10px
}

/* Ä‘á»•i mÃ u giá»›i thiÃªuj */
#introBar{
  width:100%;
  background:#000000;
  color:#e3aa0f;
  font-size:18px;
  font-weight:900;
  padding:20px 25px;
  text-align:center;
  border-top:7px solid #d81515;
  border-bottom: 7px solid #7713f1;
}

/* ===============================
   LAYOUT XEM TRUYá»†N CHUáº¨N MOBILE + PC
================================= */

.reader-container{
  display:flex;
  flex-direction:column;
  gap:15px;
  padding:10px;
  max-width:1200px;
  margin:auto;
}

/* VIDEO HIá»†N TRÆ¯á»šC TRÃŠN MOBILE */
.video-box{
  width:100%;
  background:#000;
  padding:12px;
  border-radius:12px;
  box-shadow:0 0 20px rgba(255,0,0,0.4);
}

/* MENU CHÆ¯Æ NG */
.chapter-menu{
  width:100%;
  background:#111;
  border-radius:12px;
  padding:12px;
  box-shadow:0 0 15px rgba(255,0,0,0.3);
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

/* TIÃŠU Äá»€ */
.chapter-menu h3{
  width:100%;
  color:#ff2a2a;
  margin-bottom:10px;
  font-size:16px;
  text-align:center;
}

/* CHÆ¯Æ NG */
.chapter-item{
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  background:#1a1a1a;
  color:white;
  font-size:14px;
  white-space:nowrap;
  transition:0.2s;
}

.chapter-item:hover{
  background:#300000;
}

.chapter-item.active{
  background:#cc0000;
  font-weight:bold;
}

.chapter-item.vip-lock{
  background:#222;
  color:#555;
  cursor:not-allowed;
}

/* ===== DESKTOP ===== */
@media(min-width:992px){

  .reader-container{
    flex-direction:row;
    align-items:flex-start;
  }

  .chapter-menu{
    width:260px;
    display:block;
    max-height:80vh;
    overflow-y:auto;
  }

  .chapter-item{
    display:block;
    margin-bottom:8px;
    white-space:normal;
  }

  .video-box{
    flex:1;
  }
}


</style>
</head>

<body>
<canvas id="snowCanvas"></canvas>

<header>
  <button onclick="goHome()">Trang chá»§</button>
  <input id="searchBox" placeholder="ğŸ” TÃ¬m truyá»‡n..." oninput="searchStory()">
  <button id="btnLogin" onclick="showLogin()">ÄÄƒng nháº­p</button>
  <button id="btnRegister" onclick="showRegister()">ÄÄƒng kÃ½</button>
  <button id="btnVip" onclick="showVip()" style="display:none">Náº¡p VIP</button>
  <span id="userBox"></span>
</header>

<div id="vipPanel" style="display:none"></div>

<!-- THANH GIá»šI THIá»†U -->
<div id="introBar">
  <div class="intro-title">
    ğŸŒ¸ğŸ“– WEB TRUYá»†N AUDIO VIP ğŸ“–ğŸŒ¸
  </div>

  <div class="intro-line">
    âœ¨ HÃ£y má»Ÿ khÃ³a chÆ°Æ¡ng VIP â€¢ Nghe trá»n bá»™ â€¢ KhÃ´ng quáº£ng cÃ¡o âœ¨
  </div>

  <div class="intro-note">
    ğŸŒº LÆ°u Ã½: Khi náº¡p VIP, xin hÃ£y ghi <b>ÄÃšNG Ná»˜I DUNG</b>  
    Ä‘á»ƒ <b>ADMIN gá»­i mÃ£ kÃ­ch hoáº¡t</b> ğŸŒº
  </div>

  <div class="intro-contact">
    ğŸŒ¿ Náº¿u cÃ³ váº¥n Ä‘á» gÃ¬, vui lÃ²ng liÃªn há»‡  
    <span class="zalo">ğŸ“± Zalo: 0123 456 789</span>
  </div>

  <div class="intro-wish">
    ğŸŒ¼ ChÃºc má»i ngÆ°á»i cÃ³ má»™t tráº£i nghiá»‡m vui váº» ğŸŒ¼
  </div>
</div>

<div id="stories"></div>
<div id="detail"></div>



<!-- LOGIN -->
<div class="modal" id="loginModal">
  <div class="box">
    <h3>ÄÄƒng nháº­p</h3>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPass" type="password" placeholder="Máº­t kháº©u">
    <button onclick="login()">ÄÄƒng nháº­p</button>
    <button onclick="closeModal()">ÄÃ³ng</button>
  </div>
</div>

<!-- REGISTER -->
<div class="modal" id="registerModal">
  <div class="box">
    <h3>ÄÄƒng kÃ½</h3>
    <input id="regEmail" placeholder="Email">
    <input id="regPass" type="password" placeholder="Máº­t kháº©u">
    <input id="regPhone" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i">
    <button onclick="register()">ÄÄƒng kÃ½</button>
    <button onclick="closeModal()">ÄÃ³ng</button>
  </div>
</div>

<!-- VIP -->
<div class="modal" id="vipModal">
  <div class="box" style="text-align:center">
    <h3>ğŸ‘‘ Náº P VIP</h3>

    <img src="https://img.vietqr.io/image/VCB-0123456789-compact2.png"
         style="width:200px;border-radius:10px;margin:10px auto">

    <div style="text-align:left;font-size:14px;line-height:1.6">
      <b>ğŸ¦ NgÃ¢n hÃ ng:</b> Vietcombank<br>
      <b>ğŸ‘¤ Chá»§ TK:</b> NGUYEN VAN HUY<br>
      <b>ğŸ’³ Sá»‘ TK:</b> 0123456789<br>
      <b>ğŸ“ Ná»™i dung:</b>  <span id="vipContent" style="color:red"></span> <br>
       <b> âš  VUI LÃ’NG NHáº¬P ÄÃšNG <span class="vip-important">Sá» ÄIá»†N THOáº I Cá»¦A Báº N</span>  
    VÃ€O PHáº¦N Ná»˜I DUNG CHUYá»‚N KHOáº¢N  </b> <br>
      <b>ğŸš¨Náº¿u báº¡n nháº­p sai ná»™i dung thÃ¬ vui lÃ²ng liÃªn qua </b> <br>
      <b>ğŸ“Hotline : </b><br>
      <b>ğŸ’¬Äá»ƒ admin gá»­i mÃ£ nhÃ© </b><br>
    </div>

    <hr>
    <input id="vipCode" placeholder="Nháº­p mÃ£ VIP">
    <button onclick="redeemVip()">Náº¡p VIP</button>
    <button onclick="closeModal()">ÄÃ³ng</button>
  </div>
</div>

<script>
  let currentChapterIndex = null

/* ===== SUPABASE ===== */
const { createClient } = supabase
const db = createClient(
  
  "https://bxelijlwmonamlvculqe.supabase.co",
  "sb_publishable_oCtRZaM3PlH5jLLLcst-EQ_vxMxAt4L"
)
// ğŸ‘‡ THÃŠM ÄOáº N NÃ€Y
db.auth.onAuthStateChange((event, session) => {
  user = session?.user || null
})

/* ===== STATE ===== */
let user = null
let vipExpire = null
let vipTimer = null

/* ===== DATA ===== */
const storiesData=[
  {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
cover:"https://img.youtube.com/vi/i5RfNgYNjQM/maxresdefault.jpg",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"},

 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
   {
  id:1,
 title:"Tu Äáº¡i Äáº¿",
 cover:"https://picsum.photos/300/400?1",
 desc:"Tu tiÃªn nghá»‹ch thiÃªn",
 chapters:[
  {name:"ChÆ°Æ¡ng 1",vip:false,type:"mp4",video:"https://www.w3schools.com/html/mov_bbb.mp4"},
  {name:"ChÆ°Æ¡ng 2",vip:true,type:"youtube",video:"https://www.youtube.com/embed/iFb-AkgI-Ts"},
  {name:"ChÆ°Æ¡ng 3",vip:true,type:"youtube",video:"https://www.youtube.com/embed/_DSiCsOK0PI"}
 ]},
 
 
]
async function login(){

 const email = loginEmail.value.trim()
 const password = loginPass.value.trim()

 if(!email || !password){
   return alert("Vui lÃ²ng nháº­p email vÃ  máº­t kháº©u")
 }

 const {error} = await db.auth.signInWithPassword({
   email: email,
   password: password
 })

 if(error){
   return alert("Sai email hoáº·c máº­t kháº©u")
 }

 alert("ÄÄƒng nháº­p thÃ nh cÃ´ng")
 closeModal()
 location.reload()
}

/* ===== AUTH ===== */
async function register(){

 const email = regEmail.value.trim()
 const password = regPass.value.trim()
 const phone = regPhone.value.trim()

 if(!email || !password || !phone){
   return alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin")
 }

 if(!/^[0-9]{9,11}$/.test(phone)){
   return alert("Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡")
 }

 const {error} = await db.auth.signUp({
  email: email,
  password: password
 })

 if(error) return alert(error.message)

const { error: insertError } = await db
  .from("mywebtruyen_vip")
  .upsert({
    email: email,
    vip_expire: null,
    phone: phone
  })

if(insertError){
  console.log(insertError)
}


 alert("ÄÄƒng kÃ½ thÃ nh cÃ´ng")
 closeModal()
}


/* ===== VIP REDEEM (KHÃ”NG Cá»˜NG Dá»’N â€“ MAX 30 NGÃ€Y) ===== */
async function redeemVip(){
  if(!user){
    alert("ÄÄƒng nháº­p trÆ°á»›c")
    
    return
  }
  // âŒ KhÃ´ng cho náº¡p náº¿u cÃ²n VIP
if(vipExpire && new Date(vipExpire) > new Date()){
  alert("âš  Báº¡n váº«n cÃ²n thá»i gian VIP. KhÃ´ng thá»ƒ náº¡p thÃªm.")
  return
}

  const code = vipCode.value.trim()
  if(!code){
    alert("Nháº­p mÃ£ VIP")
    return
  }

const { data, error } = await db
  .from("vip_codes")
  .select("*")
  .eq("code", code)
  .single()

if(error || !data){
  alert("âŒ MÃ£ VIP khÃ´ng há»£p lá»‡")
  return
}


// LuÃ´n 30 ngÃ y ká»ƒ tá»« hiá»‡n táº¡i
const expire = new Date()
expire.setDate(expire.getDate() + 30)


const { error: updateError } = await db
  .from("mywebtruyen_vip")
  .update({
    vip_expire: expire
  })
  .eq("email", user.email)

if(updateError){
  console.log(updateError)
  alert("Lá»—i cáº­p nháº­t VIP")
  return
}



  console.log("UPDATE ERROR:", updateError)

  await db
    .from("vip_codes")
    .update({ used: true })
    .eq("id", data.id)

vipExpire = expire
alert("ğŸ‰ Náº¡p VIP thÃ nh cÃ´ng 30 ngÃ y")

closeModal()
loadVip()
renderStoryPage(new URLSearchParams(location.search).get("story"))


  closeModal()
  await loadVip()
}

/* ===== VIP COUNTDOWN ===== */
async function loadVip(){

 const { data, error } = await db
  .from("mywebtruyen_vip")
  .select("vip_expire")
  .eq("email", user.email)

 console.log("LOAD VIP DATA:", data)

 if(error){
   console.log("LOAD VIP ERROR:", error)
   return
 }

 if(!data || data.length === 0){
   console.log("KhÃ´ng cÃ³ dÃ²ng VIP")
   return
 }

 if(!data[0].vip_expire){
   console.log("ChÆ°a cÃ³ vip_expire")
   return
 }

 vipExpire = new Date(data[0].vip_expire)

 console.log("VIP EXPIRE:", vipExpire)
 console.log("NOW:", new Date())

 if(vipExpire <= new Date()){
   console.log("VIP Ä‘Ã£ háº¿t háº¡n")
   return
 }

 vipPanel.style.display="block"

 if(vipTimer) clearInterval(vipTimer)

 vipTimer = setInterval(()=>{
  const diff = vipExpire - new Date()

  if(diff <= 0){
   vipPanel.innerText="âŒ VIP Ä‘Ã£ háº¿t háº¡n"
   vipExpire=null
   clearInterval(vipTimer)
   return
  }

  const d=Math.floor(diff/86400000)
  const h=Math.floor(diff%86400000/3600000)
  const m=Math.floor(diff%3600000/60000)
  const s=Math.floor(diff%60000/1000)

  vipPanel.innerText =
   `ğŸ‘‘ VIP cÃ²n: ${d} ngÃ y ${h} giá» ${m} phÃºt ${s} giÃ¢y`

 },1000)
}


function isVIP(){
 return vipExpire && vipExpire > new Date()
}

/* ===== UI ===== */
function renderStories(list){
 stories.innerHTML=""
 detail.innerHTML=""

 list.forEach(s=>{
  stories.innerHTML+=`
  <div class="story" onclick="openStoryPage(${s.id})">
    <img src="${s.cover}">
    <div class="story-info">
      <h3>${s.title}</h3>
      <p>${s.desc}</p>
    </div>
  </div>`
 })
}

function openStoryPage(id){
 location.href="?story="+id
}

function renderStoryPage(id){
  introBar.style.display = "none"
stories.style.display = "none"

 const s=storiesData.find(x=>x.id==id)
 const vip=isVIP()

 let menuHTML = `<h3>ğŸ“š ${s.title}</h3>`

 s.chapters.forEach((c,i)=>{
  if(c.vip && !vip){
   menuHTML+=`
   <div class="chapter-item vip-lock">
    ğŸ”’ ${c.name}
   </div>`
  }else{
   menuHTML+=`
   <div class="chapter-item ${i===currentChapterIndex?'active':''}"
    onclick="playChapter(${id},${i})">
    â–¶ ${c.name}
   </div>`
  }
 })

detail.innerHTML=`
 <div class="reader-container">

   <div class="video-box" id="videoBox">
     ${currentChapterIndex===null?'<h3 style="color:white">ğŸ“– Báº¡n hÃ£y chá»n chÆ°Æ¡ng Ä‘á»ƒ xem ğŸ§</h3>':''}
   </div>

   <div class="chapter-menu" id="chapterMenu">
     ${menuHTML}
   </div>



     ${currentChapterIndex===null?'<h3 style="color:white"></h3>':''}
   </div>
 </div>`
}


function playChapter(id,i){
 currentChapterIndex = i

 const s=storiesData.find(x=>x.id==id)
 const c=s.chapters[i]

 renderStoryPage(id)

 const videoBox=document.getElementById("videoBox")

 videoBox.innerHTML=`
 <h3 style="color:white">${c.name}</h3>
 ${c.type=="mp4"
 ?`<video controls autoplay src="${c.video}"></video>`
 :`<iframe src="${c.video}" allowfullscreen></iframe>`}`
}


function searchStory(){
 const q=searchBox.value.toLowerCase()
 renderStories(storiesData.filter(s=>s.title.toLowerCase().includes(q)))
}
function goHome(){

 introBar.style.display = "block"
 stories.style.display = "flex"
 detail.innerHTML = ""
 currentChapterIndex = null

 renderStories(storiesData)   // âš  QUAN TRá»ŒNG

 history.pushState({}, "", "?")
}


function showLogin(){loginModal.style.display="flex"}
function showRegister(){registerModal.style.display="flex"}
async function showVip(){

  if(!user){
    alert("ÄÄƒng nháº­p trÆ°á»›c")
    return
  }

  const { data, error } = await db
    .from("mywebtruyen_vip")
    .select("phone")
    .eq("email", user.email)

  if(error){
    console.log(error)
    alert("Lá»—i truy váº¥n database")
    return
  }

  if(!data || data.length === 0){
    alert("ChÆ°a cÃ³ thÃ´ng tin sá»‘ Ä‘iá»‡n thoáº¡i. Vui lÃ²ng Ä‘Äƒng kÃ½ láº¡i.")
    return
  }

  vipModal.style.display="flex"
  vipContent.innerText = data[0].phone || "ChÆ°a cÃ³ SÄT"
}





/* ===== INIT ===== */
async function init(){

  // Láº¥y session Ä‘Ãºng cÃ¡ch
  const { data: { session } } = await db.auth.getSession()

  if(session && session.user){

    user = session.user

    // áº¨n nÃºt Ä‘Äƒng nháº­p / Ä‘Äƒng kÃ½
    btnLogin.style.display="none"
    btnRegister.style.display="none"

    // Hiá»‡n nÃºt VIP
    btnVip.style.display="inline-block"

    // Hiá»ƒn thá»‹ email + nÃºt thoÃ¡t
    userBox.innerHTML =
      user.email + " <button onclick='logout()'>ThoÃ¡t</button>"

    // Load Ä‘áº¿m ngÆ°á»£c VIP
    await loadVip()

  }else{
    btnVip.style.display="none"
  }

  // Render trang
  const id=new URLSearchParams(location.search).get("story")
  id?renderStoryPage(id):renderStories(storiesData)
}

init()

function closeModal(){
  document.getElementById("loginModal").style.display = "none";
  document.getElementById("registerModal").style.display = "none";
  document.getElementById("vipModal").style.display = "none";
}

window.onclick = function(e){
  if(e.target.classList.contains("modal")){
    closeModal();
  }
}

async function logout(){
  await db.auth.signOut()
  location.reload()
}


</script>

</body>
</html>










